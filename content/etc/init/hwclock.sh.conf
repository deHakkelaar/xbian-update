#!upstart

env RTC=invalid

description "loads time saved upon reboot / shutdown"

start on started xbian-run
stop on runlevel [!2345]

pre-start script
    for r in $(find -L /sys/class/rtc/ -maxdepth 1 -mindepth 1); do
        { [ "$(cat $r/name)" != '20cc034.snvs-rtc-lp' ] || [ -z "$(cat $r/date)" ]; } && continue
        if [ $(cat $r/hctosys) = '0' ]; then
            RTC=$(basename $r)
        else
            exit 0
        fi
    done

    if test -e /run/hwclock.init; then
        exit 0
    fi

    [ -f /etc/default/rcS ] && . /etc/default/rcS
    [ "$UTC" = "yes" ] && tz="--utc" || tz="--localtime"

    if [ -e /dev/$RTC ]; then
        hwclock $tz -f /dev/$RTC --hctosys || :
    elif [ -e /etc/default/hwclock.fake ]; then
        date --set="$(cat /etc/default/hwclock.fake)"
    fi
end script

post-stop script
    [ -f /etc/default/rcS ] && . /etc/default/rcS
    [ "$UTC" = "yes" ] && tz="--utc" || tz="--localtime"

    for r in $(find -L /sys/class/rtc/ -maxdepth 1 -mindepth 1); do
        RTC=$(basename $r)
        test -e /dev/$RTC && hwclock $tz -f /dev/$RTC --systohc || :
    done

    date -R > /etc/default/hwclock.fake
end script
